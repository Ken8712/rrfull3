# 要件定義書：RRFull (Rails + Stimulus版)

## 1. プロダクト概要・背景

**名称**: RRFull（Rails × Stimulus Realtime Communication App）

**概要**:
RRFullは、2名のユーザーがスマートフォンを介して**対面でコミュニケーションする際の心理的・身体的状態を準リアルタイムで共有**できるWebアプリケーションです。Stimulusによるポーリング機能を使用し、0.5-2秒の遅延で相手の状態を確認できます。

**技術方針**:
- Rails 7のフルスタック構成を採用
- Stimulus.jsでインタラクティブな要素を実装
- WebSocketは使用せず、Ajaxポーリングで実現
- 段階的な学習が可能な構成

**目的**:
- 言語に頼らず感情・状態を共有できる手段の提供
- 非言語的な意思疎通の促進
- プログラミング初学者にも理解しやすい実装
- モバイルファーストなレスポンシブデザイン

---

## 2. 機能要件

### 🌟 コア機能（MVP）

| 機能カテゴリ | 機能詳細 | 実装方法 |
|------------|---------|---------|
| ユーザー認証 | ・メール/パスワードによるログイン<br>・新規登録<br>・ログアウト | Devise |
| セッション管理 | ・6桁のセッションコード生成<br>・コード入力による参加<br>・2名まで参加可能 | Railsモデル + Stimulus |
| タイマー共有 | ・開始/停止の同期<br>・経過時間の表示<br>・0.5秒間隔で更新 | Stimulusポーリング |
| 心理状態共有 | ・5種類の感情アイコン<br>・選択状態の共有<br>・変更履歴の保存 | Ajax + Stimulus |
| カウンター同期 | ・ハートボタンのタップ<br>・カウント数の共有<br>・アニメーション表示 | Stimulus Actions |
| 画面遷移制御 | ・待機→セッション→結果<br>・両者同時の画面遷移 | Turbo Drive |

### 🎯 性能要件

| 項目 | 目標値 | 最低要件 |
|-----|--------|---------|
| 状態同期の遅延 | 0.5-1秒 | 2秒以内 |
| ポーリング間隔 | 500ms | 1000ms |
| 同時接続数 | 50セッション | 20セッション |
| レスポンス時間 | 100ms以内 | 300ms以内 |

### 📱 非機能要件

- **対応デバイス**: スマートフォン（iOS Safari, Android Chrome）
- **画面サイズ**: 320px〜428px幅を基準
- **通信環境**: 4G/5G環境で快適に動作
- **セキュリティ**: HTTPS必須、CSRF対策
- **可用性**: 1セッション最大60分

---

## 3. 画面仕様

### 3.1 認証画面
```
[ログイン画面]
- メールアドレス入力欄
- パスワード入力欄
- ログインボタン
- 新規登録リンク
```

### 3.2 ホーム画面
```
[セッション開始/参加]
- 「新規セッション」ボタン
- セッションコード入力欄
- 「参加する」ボタン
- 参加中のセッション一覧
```

### 3.3 セッション画面
```
[ヘッダー]
- セッションコード表示
- 接続状態インジケーター
- 退出ボタン

[メインエリア]
- タイマー表示（MM:SS）
- 開始/停止ボタン
- 自分の感情アイコン選択
- 相手の感情アイコン表示
- ハートカウンター
- メッセージ表示エリア

[フッター]
- セッション終了ボタン
```

### 3.4 結果画面
```
[セッションサマリー]
- 経過時間
- 感情の変化グラフ
- ハートカウント合計
- もう一度ボタン
- ホームへ戻るボタン
```

---

## 4. Stimulus実装仕様

### 4.1 コントローラー構成

| Stimulusコントローラー | 責務 | 更新頻度 |
|---------------------|------|---------|
| session_controller | セッション全体の状態管理 | 500ms |
| timer_controller | タイマーの表示・同期 | 500ms |
| emotion_controller | 感情アイコンの選択・表示 | 即時 + 500ms |
| counter_controller | カウンターの増減・同期 | 即時 + 500ms |
| connection_controller | 接続状態の監視 | 2000ms |

### 4.2 データ属性による設定

```html
<!-- Stimulusデータ属性の使用例 -->
<div data-controller="session"
     data-session-id-value="<%= @session.id %>"
     data-session-url-value="<%= session_path(@session) %>"
     data-session-interval-value="500">
</div>
```

### 4.3 エラーハンドリング

- ネットワークエラー時の再試行（最大3回）
- タイムアウト処理（5秒）
- エラーメッセージの表示
- オフライン時の警告

---

## 5. API仕様

### 5.1 エンドポイント一覧

| メソッド | パス | 説明 | レスポンス |
|---------|------|------|----------|
| GET | /sessions/:id/status | セッション状態取得 | JSON |
| POST | /sessions/:id/timer | タイマー操作 | JSON |
| POST | /sessions/:id/emotion | 感情更新 | JSON |
| POST | /sessions/:id/counter | カウンター更新 | JSON |
| POST | /sessions/:id/complete | セッション終了 | JSON |

### 5.2 レスポンス形式

```json
{
  "session": {
    "id": 123,
    "code": "ABC123",
    "status": "active",
    "timer": {
      "running": true,
      "elapsed_seconds": 125
    },
    "participants": [
      {
        "id": 1,
        "name": "ユーザー1",
        "emotion": "happy",
        "last_seen": "2025-01-20T10:30:00Z"
      }
    ],
    "counter": 42
  }
}
```

---

## 6. 段階的実装計画

### Phase 1: 基本機能（1週目）
- [ ] Devise認証実装
- [ ] セッションモデル作成
- [ ] 基本的な画面遷移
- [ ] Stimulusセットアップ

### Phase 2: リアルタイム機能（2週目）
- [ ] ポーリング機能実装
- [ ] タイマー同期
- [ ] 感情アイコン同期
- [ ] カウンター同期

### Phase 3: UI/UX改善（3週目）
- [ ] レスポンシブ対応
- [ ] アニメーション追加
- [ ] エラーハンドリング
- [ ] パフォーマンス最適化

### Phase 4: 仕上げ（4週目）
- [ ] 結果画面実装
- [ ] テスト作成
- [ ] デプロイ準備
- [ ] ドキュメント整備